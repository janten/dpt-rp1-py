#!/usr/bin/env python3
# coding=utf-8

import argparse
import base64
import sys
import json
import os
import re

from pathlib import Path
from dptrp1.dptrp1 import DigitalPaper

def do_screenshot(d, filename):
    pic = d.take_screenshot()
    with open(filename, 'wb') as f:
        f.write(pic)

def do_list_documents(d):
    data = d.list_documents()
    for d in data:
        print(d['entry_path'])

def do_list_folders(d, *remote_paths):
    data = d.list_all()
    for d in data:
        if d['entry_type'] == 'folder':
            print(d['entry_path'] + '/')

def do_upload(d, local_path, remote_path=''):
    if not remote_path:
        remote_path = 'Document/' + os.path.basename(local_path)
    with open(local_path, 'rb') as fh:
        d.upload(fh, remote_path)

def do_download(d, remote_path, local_path):
    data = d.download(remote_path)

    if os.path.isdir(local_path):
        re.sub('/?$', '/', local_path)
        local_path += os.path.basename(remote_path)

    with open(local_path, 'wb') as f:
        f.write(data)

def do_document_info(d, remote_path):
    data = d.document_info(remote_path)
    for key in data:
        print(key + ": " + data[key])

def do_update_firmware(d, local_path):
    with open(local_path, 'rb') as fwfh:
        d.update_firmware(fwfh)

def do_delete_document(d, remote_path):
    data = d.delete_document(remote_path)

def do_new_folder(d, remote_path):
    d.new_folder(remote_path)

def do_wifi_list(d):
    data = d.wifi_list()
    print(json.dumps(data, indent=2))

def do_wifi_scan(d):
    data = d.wifi_scan()
    print(json.dumps(data, indent=2))

def do_wifi(d):
    print(d.wifi_enabled()['value'])

def do_wifi_enable(d):
    print(d.enable_wifi())

def do_wifi_disable(d):
    print(d.disable_wifi())

def do_add_wifi(d):
    print(d.configure_wifi(ssid = "vecna2",
                     security = "psk",
                     passwd = "elijah is a cat",
                     dhcp = "true",
                     static_address = "",
                     gateway = "",
                     network_mask = "",
                     dns1 = "",
                     dns2 = "",
                     proxy = "false"))

def do_delete_wifi(d):
    print(d.delete_wifi(ssid = "vecna2", security = "psk"))

def do_register(d):
    d.register()

if __name__ == "__main__":

    dpapp = "Sony Corporation/Digital Paper App"
    if sys.platform.startswith('darwin'):
        dpapp = "Library/Application Support" / dpapp
    elif sys.platform.startswith('windows'):
        dpapp = "AppData/Roaming" / dpapp
    elif sys.platform.startswith('linux'):
        dpapp = ".dpapp"
    dpapp = Path.home() / dpapp
    deviceid = str(dpapp / "deviceid.dat")
    privatekey = str(dpapp / "privatekey.dat")

    commands = {
        "screenshot": do_screenshot,
        "list-documents" : do_list_documents,
        "upload" : do_upload,
        "download" : do_download,
        "document-info" : do_document_info,
        "delete" : do_delete_document,
        "new-folder" : do_new_folder,
        "list-folders" : do_list_folders,
        "wifi-list": do_wifi_list,
        "wifi-scan": do_wifi_scan,
        "wifi-add": do_add_wifi,
        "wifi-del": do_delete_wifi,
        "wifi": do_wifi,
        "wifi-enable" : do_wifi_enable,
        "wifi-disable" : do_wifi_disable,
        "register" : do_register,
        "update": do_update_firmware
    }

    def build_parser():
        p = argparse.ArgumentParser(description = "Remote control for Sony DPT-RP1")
        p.add_argument('--client-id',
                help = "File containing the device's client id",
                default = deviceid,
                required = not os.path.isfile(deviceid))
        p.add_argument('--key',
                help = "File containing the device's private key",
                default = privatekey,
                required = not os.path.isfile(privatekey))
        p.add_argument('--addr',
                help = "Hostname or IP address of the device")
        p.add_argument('command',
                help = 'Command to run',
                choices = sorted(commands.keys()))
        p.add_argument('command_args',
                help = 'Arguments for the command',
                nargs = '*')

        return p


    args = build_parser().parse_args()

    dp = DigitalPaper(addr = args.addr)

    if args.command == "register":
        _, key, device_id = dp.register()

        with open(args.key, 'w') as f:
            f.write(key)

        with open(args.client_id, 'w') as f:
            f.write(device_id)

        sys.exit()

    else:
        with open(args.client_id) as fh:
            client_id = fh.readline().strip()

        with open(args.key, 'rb') as fh:
            key = fh.read()

        dp.authenticate(client_id, key)

    commands[args.command](dp, *args.command_args)

